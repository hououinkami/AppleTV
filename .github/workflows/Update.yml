name: ç”Ÿæˆè‡ªç”¨Apple TVç›´æ’­åˆ—è¡¨

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/*.yml'
      - 'ChannelList/*.list'
      - 'ChannelLogo/*/*.png'
  schedule:
    - cron: 0 */1 * * *
  watch:
    types: [started]

env:
  TZ: Asia/Shanghai
  TELEGRAM_NOTIFICATION: false
  TELEGRAM_NOTIFICATION_CONTENT: <b>ğŸ“º AppleTVãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«ãŒæ›´æ–°ã—ã¾ã—ãŸï¼</b>
  GROUP_NAME_CCTV: å¤®è§†
  GROUP_NAME_SATT: å«è§†
  GROUP_NAME_CCTVv6: IPv6å¤®è§†
  GROUP_NAME_SATTv6: IPv6å«è§†
  GROUP_NAME_LOCAL: IPv6åœ°æ–¹
  GROUP_NAME_DIG: IPv6æ•°å­—
  GROUP_NAME_JP: æ—¥æœ¬
  GROUP_NAME_EN: è‹±æ–‡
  GROUP_NAME_SCI: ç§‘æ•™
  GROUP_NAME_HK: é¦™æ¸¯
  GROUP_NAME_TW: å°æ¹¾
  GROUP_NAME_MO: æ¾³é—¨
  HKTW_ADD: false
  GET: true

jobs:
  GenerateList:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        ref: main
        fetch-depth: 0
        lfs: true
    
    - name: Set git identity
      run : |
        git config --global user.email "hououinkami@gmail.com"
        git config --global user.name "hououinkami"
    
    - name: è·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    
    - name: è·å–æœ€æ–°æº
      run : |
        wget https://raw.githubusercontent.com/Kimentanm/aptv/master/m3u/iptv.m3u -O aptv.tmp
        wget https://raw.githubusercontent.com/YueChan/Live/main/IPTV.m3u -O yuechan.tmp
        wget https://raw.githubusercontent.com/YanG-1989/m3u/main/Gather.m3u -O gather.tmp

    - name: APTVå›½å†…é¢‘é“IPv4
      run : |
        # ç”ŸæˆAPTVå¤®è§†å«è§†V4
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"å¤®è§†IPV4\"/ || $0~/group-title=\"å«è§†IPV4\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub("å¤®è§†IPV4","'"$GROUP_NAME_CCTV"'");
            gsub("\"å«è§†IPV4","\"'"$GROUP_NAME_SATT"'");
            gsub(/CCTV5.\"/,"CCTV5+ä½“è‚²èµ›äº‹\"");
            print $0;
          };
        }
        ' aptv.tmp>Source/APTV_v4.m3u
        echo "********APTVä¸´æ—¶æ–‡ä»¶********"
        cat Source/aptv_v4.m3u

    - name: å›½å†…é¢‘é“IPv6
      run : |
        # ç”ŸæˆV6ä¸´æ—¶æ–‡ä»¶
        awk '
        {
          gsub("\"å¤®è§†","\"'"$GROUP_NAME_CCTVv6"'");
          if($0~/(tvg-name=\"CCTV|CCTV4K)/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_CCTVv6"'\"")};
          gsub(/CCTV5.\"/,"CCTV5+ä½“è‚²èµ›äº‹\"");
          gsub("\"ç”µè§†æŒ‡å—","\"CCTVç”µè§†æŒ‡å—");
          gsub(/tvg-name=\"ä¸­å›½æ•™è‚²/,"tvg-name=\"CETV");
          if($0~/NEWTV/) {gsub(",",",NEWTV")};
          if($0~/tvg-name=\"(CCTV|CETV|CGTN)/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_CCTVv6"'\"")};
          if($0~/group-title=\"å«è§†\"/ && $0!~/tvg-name=\".*å«è§†\".*tvg-logo/) {gsub("\"å«è§†","\"'"$GROUP_NAME_LOCAL"'")};
          if($0~/tvg-name=\".*å«è§†\".*tvg-logo/ || $0~/å‡¤å‡°/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_SATTv6"'\"")};
          if($0!~/group-title=\"('"$GROUP_NAME_CCTVv6"'|'"$GROUP_NAME_SATTv6"'|'"$GROUP_NAME_LOCAL"')\"/) {gsub(/group-title=\".*\"/, "group-title=\"'"$GROUP_NAME_DIG"'\"")};
          print $0;
        }
        ' yuechan.tmp>yuechan_v6.tmp
        echo "********V6ä¸´æ—¶æ–‡ä»¶********"
        cat yuechan_v6.tmp

        # ç”ŸæˆV6å¤®è§†å«è§†
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"'"$GROUP_NAME_CCTVv6"'\"/ || $0~/group-title=\"'"$GROUP_NAME_SATTv6"'\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            print $0;
          };
        }
        ' yuechan_v6.tmp>chinav6_1.tmp
        echo "********V6å¤®è§†å«è§†********"
        cat chinav6_1.tmp

        # ç”ŸæˆV6åœ°æ–¹ç”µè§†å°
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"'"$GROUP_NAME_LOCAL"'\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            print $0;
          };
        }
        ' yuechan_v6.tmp>localv6.tmp
        echo "********V6åœ°æ–¹é¢‘é“********"
        cat localv6.tmp

        # ç”ŸæˆAPTVå¤®è§†å«è§†V6
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\"å¤®è§†IPV6\"/ || $0~/group-title=\"å«è§†IPV6\"/ || $0~/group-title=\"å…¶ä»–\"/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub("å¤®è§†IPV6","'"$GROUP_NAME_CCTVv6"'");
            gsub("\"å«è§†IPV6","\"'"$GROUP_NAME_SATTv6"'");
            gsub(/CCTV5.\"/,"CCTV5+ä½“è‚²èµ›äº‹\"");
            print $0;
          };
        }
        ' aptv.tmp>chinav6_2.tmp
        echo "********APTVä¸´æ—¶æ–‡ä»¶********"
        cat chinav6_2.tmp

        # ç”ŸæˆV6æ•°å­—ç”µè§†å°
        awk '
        {
          if($0~/group-title=\"('"$GROUP_NAME_CCTVv6"'|'"$GROUP_NAME_SATTv6"'|'"$GROUP_NAME_LOCAL"')\"/) {next};
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            print $0;
          };
        }
        ' yuechan_v6.tmp>Source/Otherv6.m3u
        echo "********V6å…¶ä»–********"
        cat Source/Otherv6.m3u

        cat chinav6_1.tmp chinav6_2.tmp > Source/China_v6.m3u

    - name: é‡æ–°æ’åºå›½å†…é¢‘é“å¹¶æ›´æ¢é€æ˜å›¾æ ‡
      run : |
        awk '
        {
          gsub("\"å¤®è§†","\"'"$GROUP_NAME_CCTV"'");
          gsub("\"å«è§†","\"'"$GROUP_NAME_SATT"'");
          print $0;
        }
        ' ChannelList/China.list>Chinalist.tmp

        awk -F'"' '
        {
          info=$0;
          name=$4;
          gsub(/group-title=\"å¤®è§†\"/, "group-title=\"'"$GROUP_NAME_CCTV"'\"");
          gsub(/group-title=\"å«è§†\"/, "group-title=\"'"$GROUP_NAME_SATT"'\"");
          # åˆ°ç¬¬ä¸€ä¸ªç©ºè¡Œä¸ºæ­¢ if(length(info)==0) {exit};
          if(info~/\#EXIT/) {exit};
          if($0~/\#EXTM3U/) {print $0};
          if(info~/ç»¼åˆ/) {
            name="CCTV1\"";
            close("Source/APTV_v4.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/APTV_v4.m3u";
            cmd | getline churl;
            print info;
            print churl;
            close(cmd);
            next;
          };
          if(info~/ä½“è‚²èµ›äº‹/) {
            name="ä½“è‚²èµ›äº‹";
            close("Source/APTV_v4.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/APTV_v4.m3u";
            cmd | getline churl;
            print info;
            print churl;
            close(cmd);
            next;
          };
          if(info~/EXTINF/ && info!~/HaveURL/) {
            churl="null";
            close("Source/APTV_v4.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/APTV_v4.m3u";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' Chinalist.tmp>China_v4.m3u

        awk '
        {
          gsub("\"å¤®è§†","\"'"$GROUP_NAME_CCTVv6"'");
          gsub("\"å«è§†","\"'"$GROUP_NAME_SATTv6"'");
          print $0;
        }
        ' ChannelList/China.list>Chinalist.tmp

        awk -F'"' '
        {
          info=$0;
          name=$4;
          # åˆ°ç¬¬ä¸€ä¸ªç©ºè¡Œä¸ºæ­¢ if(length(info)==0) {exit};
          if(info~/\#EXIT/) {exit};
          if($0~/\#EXTM3U/) {print $0};
          if(info~/ç»¼åˆ/) {
            name="CCTV1\"";
            close("Source/China_v6.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/China_v6.m3u";
            cmd | getline churl;
            print info;
            print churl;
            close(cmd);
            next;
          };
          if(info~/ä½“è‚²èµ›äº‹/) {
            name="ä½“è‚²èµ›äº‹";
            close("Source/China_v6.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/China_v6.m3u";
            cmd | getline churl;
            print info;
            print churl;
            close(cmd);
            next;
          };
          if(info~/EXTINF/ && info!~/HaveURL/) {
            churl="null";
            close("Source/China_v6.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/China_v6.m3u";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' Chinalist.tmp>China_v6.tmp

        cat China_v6.tmp localv6.tmp Source/Otherv6.m3u > China_v6.m3u

    - name: å…¶ä»–é¢‘é“
      if: env.GET == 'true'
      run : |
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0!~/(IPV6|å’ªå’•)/ && $0 !~/^http/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub("å¤®è§†IPV4","'"$GROUP_NAME_CCTV"'");
            gsub("\"å«è§†IPV4","\"'"$GROUP_NAME_SATT"'");
            gsub(/CCTV5.\"/,"CCTV5+ä½“è‚²èµ›äº‹\"");
            print $0;
          };
        }
        ' gather.tmp>Source/Gather.m3u
        echo "********Gatherä¸´æ—¶æ–‡ä»¶********"
        cat Source/Gather.m3u

    - name: æ—¥æœ¬é¢‘é“
      if: env.GET == 'true'
      run : |
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/group-title=\".*æ—¥æœ¬\"/) {
            gsub(/group-title=\".*æ—¥æœ¬\"/,"group-title=\"'"$GROUP_NAME_JP"'\"");
            gsub(/J SPORTS/,"J Sports");
            getline churl;
            if(churl!~/movie\.mcas\.jp/) {
              print $0;
              print churl;
            };
          };
        }
        ' gather.tmp>japan1.tmp

        wget https://raw.githubusercontent.com/iptv-org/iptv/master/streams/jp.m3u -O japan.tmp
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/\#EXTINF/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub(/ \(.*p\)/,"");
            gsub(",TBS",",TBS TV");
            gsub(/\",/,"\" group-title=\"'"$GROUP_NAME_JP"'\",");
            print $0;
          };
        }
        ' japan.tmp>japan2.tmp

        cat japan1.tmp japan2.tmp > Source/Japan.m3u

        awk '
        {
          gsub("\"æ—¥æœ¬","\"'"$GROUP_NAME_JP"'");
          print $0;
        }
        ' ChannelList/Japan.list>Japanlist.tmp
        
        awk -F'"' '
        {
          info=$0;
          name=$4;
          if(info~/\#EXIT/) {exit};
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/) {
            if(info!~/URLARU/) {churl="null"} else {getline churl};
            close("Source/Japan.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/Japan.m3u";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' Japanlist.tmp>Japan.m3u

    - name: è‹±æ–‡é¢‘é“
      if: env.GET == 'true'
      run : |
        awk '
        {
          gsub("group-title=\"è‹±æ–‡\"","group-title=\"'"$GROUP_NAME_EN"'\"");
          print $0;
        }
        ' ChannelList/English.list>Englishlist.tmp

        awk -F'"' '
        {
          info=$0;
          name=$4;
          if(info~/\#EXIT/) {exit};
          if($0~/\#EXTM3U/) {print $0};
          if(info~/EXTINF/) {
            if(info!~/URLARU/) {churl="null"};
            if(info~/URLARU/) {getline churl};
            close("gather.tmp");
            cmd="awk '\''/"name"/{getline;print}'\'' gather.tmp";
            cmd | getline churl;
            if(churl!="null") {
              print info;
              print churl;
            };
            close(cmd);
          };
        }
        ' Englishlist.tmp>English.m3u

    - name: ç§‘å­¦è®°å½•é¢‘é“
      if: env.GET == 'false'
      run : |
        awk '
        {
          gsub("group-title=\"..ç§‘æ•™.*\"","group-title=\"'"$GROUP_NAME_SCI"'\"");
          print $0;
        }
        ' ChannelList/Sciences.list>Sciencestmp1.m3u

        cat Sciencestmp*.m3u > Sciences.m3u

    - name: ç”ŸæˆAppleTVæ€»åˆ—è¡¨
      run : |
        cat China_v4.m3u Japan.m3u English.m3u > IPTV.m3u
    
    - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
      run : |
        rm -rf *.tmp
        ls
    
    - name: åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
      if: (!cancelled())
      id: status
      run: |
        STR1="nothing to commit, working tree clean"
        STR2="Changes not staged for commit"
        out=$(git status)
        if [[ "$(echo $out | grep "$STR1")" != "" ]]
        then
          echo "STATUS="nochange"" >> $GITHUB_OUTPUT
        fi
        if [[ "$(echo $out | grep "$STR2")" != "" ]]
        then
          echo "STATUS="change"" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆå¹¶åˆ°ä»“åº“
      if: (!cancelled())
      run : |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          git add .
          git commit -m  "Update:${{steps.date.outputs.DATE}}"
          git push origin main
        fi

    - name: ç§»é™¤workflowè¿è¡Œ
      if: (!cancelled())
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Telegramæ¨é€
      if: env.TELEGRAM_NOTIFICATION == 'true' && !cancelled()  
      run: |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=${{ env.TELEGRAM_NOTIFICATION_CONTENT }}&parse_mode=HTML"
          # curl -d "text=ğŸ“º AppleTVãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«æ›´æ–°ã—ã¾ã—ãŸï¼" -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendmessage?chat_id=${{ secrets.TELEGRAM_CHAT_ID }}"
        fi
        
