name: ç”Ÿæˆè‡ªç”¨Apple TVç›´æ’­åˆ—è¡¨

on:
  push:
    branches:
      - beta
    path:
      - 'start'
  release:
    types: [published]
  schedule:
    - cron: 0 4,16 * * *
  watch:
    types: [started]

env:
  TZ: Asia/Shanghai
  TELEGRAM_NOTIFICATION: true
  TELEGRAM_NOTIFICATION_CONTENT: <b>ğŸ“º AppleTVãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«æ›´æ–°ã—ã¾ã—ãŸï¼</b>
  SOURCE: https://raw.githubusercontent.com/LiuYi0526/IPTV/master/IPTV.m3u
  SOURCE_NAME: IPTV_tmp.m3u
  GROUP_NAME_CCTV: å¤®è§†é¢‘é“
  GROUP_NAME_SATT: å«è§†é¢‘é“
  GROUP_NAME_HK: é¦™æ¸¯é¢‘é“
  GROUP_NAME_JP: æ—¥æœ¬é¢‘é“
  GROUP_NAME_EN: è‹±æ–‡é¢‘é“
  GROUP_NAME_SCI: ç§‘æ•™è®°å½•
  GROUP_NAME_TW: å°æ¹¾é¢‘é“
  GROUP_NAME_MO: æ¾³é—¨é¢‘é“
  HKTW_ADD: false

jobs:
  GenerateList:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        ref: master
        fetch-depth: 0
        lfs: true
    
    - name: Set git identity
      run : |
        git config --global user.email "hououinkami@gmail.com"
        git config --global user.name "hououinkami"
    
    - name: è·å–å½“å‰æ—¥æœŸ
      id: date
      run: echo "::set-output name=DATE::$(date +'%Y-%m-%d')"
    
    - name: è·å–æœ€æ–°æº
      run : |
        wget $SOURCE -O $SOURCE_NAME
    
    - name: å›½å†…é¢‘é“
      run : |
        awk '
        {
          if($0~/\#EXTM3U/) {print $0};
          if($0~/\#å¤®è§†|\#å«è§†/) {print $0};
          if($0~/CCTV-|å«è§†/ && $0!~/è´­ç‰©/) {m=NR; n=NR+1};
          if(m<=NR && NR<=n) {
            gsub("ä¸­å›½å¤®è§†","'"$GROUP_NAME_CCTV"'");
            gsub("ä¸­å›½å«è§†","'"$GROUP_NAME_SATT"'");
            gsub(" é«˜æ¸…","")
            if($0~/æ·±åœ³/) {gsub("tvg-id=\"[0-9]{1,2}\"","tvg-id=\"26\"")};
            print $0;
          };
        }
        ' $SOURCE_NAME>Source/China.m3u

    - name: é‡æ–°æ’åºå›½å†…é¢‘é“å¹¶æ›´æ¢é€æ˜å›¾æ ‡
      run : |
        awk -F'"' '
        {
          info=$0;
          name=$4;
          print info;
          if(info~/EXTINF/ && info!~/ä½“è‚²èµ›äº‹|æ–°é—»/) {
            close("Source/China.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/China.m3u";
            cmd | getline churl;
            print churl;
            close(cmd);
          };
          if(info~/ä½“è‚²aèµ›äº‹/) {
            name="ä½“è‚²èµ›äº‹";
            close("Source/China.m3u");
            cmd="awk '\''/"name"/{getline;print}'\'' Source/China.m3u";
            cmd | getline churl;
            print churl;
            close(cmd);
          };
          gsub("group-title=\"..å¤®è§†.*\"","group-title=\"'"$GROUP_NAME_CCTV"'\"");
          gsub("group-title=\"..å«è§†.*\"","group-title=\"'"$GROUP_NAME_SATT"'\"");
        }
        ' ChannelList/China.list>China.m3u

    - name: å¤–æ–‡é¢‘é“
      run : |
        # æ—¥æœ¬é¢‘é“
        awk '
        {
          gsub("group-title=\"..æ—¥æœ¬.*\"","group-title=\"'"$GROUP_NAME_JP"'\"");
          print $0;
        }
        ' ChannelList/Japan.list>Japantmp1.m3u

        cat Japantmp*.m3u > Japan.m3u

        # è‹±æ–‡é¢‘é“
        awk '
        {
          gsub("group-title=\"..è‹±æ–‡.*\"","group-title=\"'"$GROUP_NAME_EN"'\"");
          print $0;
        }
        ' ChannelList/English.list>English.m3u

    - name: ç§‘å­¦è®°å½•é¢‘é“
      run : |
        awk '
        {
          gsub("group-title=\"..ç§‘æ•™.*\"","group-title=\"'"$GROUP_NAME_SCI"'\"");
          print $0;
        }
        ' ChannelList/Sciences.list>Sciencestmp1.m3u

        cat Sciencestmp*.m3u > Sciences.m3u

    - name: ç”ŸæˆAppleTVæ€»åˆ—è¡¨
      run : cat China.m3u Japan.m3u English.m3u > IPTV.m3u
    
    - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
      run : |
        rm $SOURCE_NAME
        rm *tmp*.m3u
        ls
    
    - name: åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´
      id: status
      run: |
        STR1="nothing to commit, working tree clean"
        STR2="Changes not staged for commit"
        out=$(git status)
        if [[ "$(echo $out | grep "$STR1")" != "" ]]
        then
          echo "::set-output name=STATUS::"nochange""
        fi
        if [[ "$(echo $out | grep "$STR2")" != "" ]]
        then
          echo "::set-output name=STATUS::"change""
        fi
    
    - name: åˆå¹¶åˆ°ä»“åº“
      run : |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          git add .
          git commit -m  "Update:${{steps.date.outputs.DATE}}"
          git push origin master
        fi

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 11

    - name: Telegramæ¨é€
      if: env.TELEGRAM_NOTIFICATION == 'true' && !cancelled()  
      run: |
        if [[ "${{steps.status.outputs.STATUS}}" == "change" ]]
        then
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=${{ env.TELEGRAM_NOTIFICATION_CONTENT }}&parse_mode=HTML"
          # curl -d "text=ğŸ“º AppleTVãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒ³ãƒãƒ«æ›´æ–°ã—ã¾ã—ãŸï¼" -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendmessage?chat_id=${{ secrets.TELEGRAM_CHAT_ID }}"
        fi
        
